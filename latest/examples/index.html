<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Martin">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Examples - Discuit.jl</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../assets/Documenter.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Discuit.jl</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Introduction</a>
                    </li>
                    <li class="active">
                        <a href="./">Examples</a>
                    </li>
                    <li >
                        <a href="../models/">Models</a>
                    </li>
                    <li >
                        <a href="../manual/">Manual</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../models/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/mjb3/Discuit.jl/edit/master/docs/examples.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#discuitjl-examples">Discuit.jl examples</a></li>
            <li><a href="#sis-model">SIS model</a></li>
            <li><a href="#custom-mcmc">Custom MCMC</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><a id='Discuit.jl-examples-1'></a></p>
<h1 id="discuitjl-examples">Discuit.jl examples</h1>
<p>The following examples provide a flavour of Discuit's core functionality. See the <a href="../manual/#Discuit.jl-manual-1">Discuit.jl manual</a> for more detailed instructions.</p>
<p><a id='SIS-model-1'></a></p>
<h2 id="sis-model">SIS model</h2>
<p>The following example is based on that published by Pooley et al. in 2015 in the paper that introduces the model based proposal method. We could use <code>generate_model("SIS", [100,1])</code> to generate the model but constructing it manually is a helpful exercise for getting to know the package. We start by examining <code>DiscuitModel</code> in the package documentation:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; using Discuit;</code></pre>


<p>Now that we know the necessary parameters for defining a model we can begin by defining a rate function. Note that the correct signature must be used in order for it to be compatible with the package:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; function sis_rf(output::Array{Float64, 1}, parameters::Array{Float64, 1}, population::Array{Int64, 1})
           output[1] = parameters[1] * population[1] * population[2]
           output[2] = parameters[2] * population[2]
       end
sis_rf (generic function with 1 method)</code></pre>


<p>Next we define a simple observation function, again with the correct signature:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; obs_fn(population::Array{Int64, 1}) = population
obs_fn (generic function with 1 method)</code></pre>


<p>Naturally we choose the same prior distribution as Pooley so that we can compare results. The return type must be Float.</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; function weak_prior(parameters::Array{Float64, 1})
           parameters[1] &gt; 0.0 || return 0.0
           parameters[2] &gt; 0.0 || return 0.0
           return 1.0
       end
weak_prior (generic function with 1 method)</code></pre>


<p>Finally, we define an observation likelihood model. Again, we use the same as Pooley, with observation errors normally distributed around the true value with standard deviation <code>2</code>:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; function si_gaussian(y::Array{Int64, 1}, population::Array{Int64, 1})
           obs_err = 2
           tmp1 = log(1 / (sqrt(2 * pi) * obs_err))
           tmp2 = 2 * obs_err * obs_err
           obs_diff = y[2] - population[2]
           return tmp1 - ((obs_diff * obs_diff) / tmp2)
       end
si_gaussian (generic function with 1 method)</code></pre>


<p>We can now define a model. The three parameters declared inline are the transition matrix; an optional index for the t0 parameter (ignore for now); and the initial condition which represents the state of the population at the origin of each trajectory:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; model = DiscuitModel(&quot;SIS&quot;, sis_rf, [-1 1; 1 -1], 0, [100, 1], obs_fn, weak_prior, si_gaussian);</code></pre>


<p><a id='Simulation-1'></a></p>
<h3 id="simulation">Simulation</h3>
<p>Although our main goal is to replicate the analysis of Pooley et al. we can also run a simulation using the <code>gillespie_sim</code> function.</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; xi = gillespie_sim(model, [0.003, 0.1]);</code></pre>


<p>We can also visualise the results using the corresponding R package: rDiscuit. ADD LINK</p>
<p><img alt="SIS simulation" src="https://raw.githubusercontent.com/mjb3/Discuit.jl/master/docs/img/sis-sim.png" /></p>
<p><a id='MCMC-1'></a></p>
<h3 id="mcmc">MCMC</h3>
<p>Running an MCMC analysis based on a set of observations data is simple. TBC...</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; obs = Observations([20, 40, 60, 80, 100], [0 18; 0 65; 0 70; 0 66; 0 67]);

julia&gt; rs = run_met_hastings_mcmc(model, obs, [0.003, 0.1]);

running MCMC.
julia&gt; print(rs.mean)
[0.00312919, 0.105038]</code></pre>


<p>Placeholder for MCMC output.</p>
<p><img alt="MCMC traceplots" src="https://raw.githubusercontent.com/mjb3/Discuit.jl/master/docs/img/traceplots.png" /></p>
<p><img src="https://raw.githubusercontent.com/mjb3/Discuit.jl/master/docs/img/traceplots.png" alt="MCMC traceplots" height="180"/></p>
<p><a id='Diagnostic-1'></a></p>
<h3 id="diagnostic">Diagnostic</h3>
<p><a id='Geweke-1'></a></p>
<h4 id="geweke">Geweke</h4>
<p>NEED TO ADD geweke definition...</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; rs.geweke
([2000, 4000, 6000, 8000, 10000, 12000, 14000, 16000, 18000, 20000], [0.0593269 0.0762652; -0.207333 -0.227765; â€¦ ; -0.0936278 -0.147329; -0.414237 -0.403234])</code></pre>


<p><img alt="MCMC analysis" src="https://raw.githubusercontent.com/mjb3/Discuit.jl/master/docs/img/geweke_heatmap.png" /></p>
<p><a id='Gelman-Rubin-diagnostic-1'></a></p>
<h4 id="gelman-rubin-diagnostic">Gelman-Rubin diagnostic</h4>
<p>NEED TO ADD gelman definition...</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; rs = run_gelman_diagnostic(model, obs, [0.0025 0.08; 0.003 0.12; 0.0035 0.1]);

running gelman diagnostic...
 chain 1 complete
 chain 2 complete
 chain 3 complete
julia&gt; rs.mu
2-element Array{Float64,1}:
 0.003217194906792425
 0.10844858844830059

julia&gt; ac = compute_autocorrelation(rs.mcmc);</code></pre>


<p><a id='Autocorrelation-1'></a></p>
<h4 id="autocorrelation">Autocorrelation</h4>
<p>NEED TO ADD autocorr definition...</p>
<p><img src="https://raw.githubusercontent.com/mjb3/Discuit.jl/master/docs/img/sis-sim.png" alt="SIS simulation" height="180"/></p>
<p><a id='Custom-MCMC-1'></a></p>
<h2 id="custom-mcmc">Custom MCMC</h2>
<p>Some situations...</p>
<p>First we generate a standard <a href="../models/#SIR-1">SIR</a> model and set the <code>t0_index = 3</code>.</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; model = generate_model(&quot;SIR&quot;, [119, 1, 0]);

julia&gt; model.t0_index = 3;</code></pre>


<p>Next we define the "medium" prior used by O'Neill and Roberts, with some help from the <a href="https://github.com/JuliaStats/Distributions.jl">Distributions.jl</a> package:</p>
<pre class="codehilite"><code class="language-julia-repl">  Updating registry at `~/.julia/registries/General`
  Updating git-repo `https://github.com/JuliaRegistries/General.git`
[?25l[2K[?25h Resolving package versions...
  Updating `~/build/mjb3/Discuit.jl/docs/Project.toml`
  [31c24e10] + Distributions v0.16.4
  Updating `~/build/mjb3/Discuit.jl/docs/Manifest.toml`
 [no changes]

julia&gt; using Distributions;

julia&gt; p1 = Gamma(10, 0.0001);

julia&gt; p2 = Gamma(10, 0.01);

julia&gt; function prior_density(parameters::Array{Float64, 1})
           return parameters[3] &lt; 0.0 ? pdf(p1, parameters[1]) * pdf(p2, parameters[2]) * (0.1 * exp(0.1 * parameters[3])) : 0.0
       end
prior_density (generic function with 1 method)

julia&gt; model.prior_density = prior_density;</code></pre>


<p>The observation model is replaced with one that returns <code>log(1)</code> since we will only propose sequences consitent with the observed recoveries and $\pi(\xi | \theta)$ is evaluated automatically by Discuit):</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; observation_model(y::Array{Int, 1}, population::Array{Int, 1}) = 0.0
observation_model (generic function with 1 method)

julia&gt; model.observation_model = observation_model;</code></pre>


<p>Next we define an array <code>t</code> to contain the recovery times reported by O'Neill and Roberts and a simple <code>Observations</code> variable which consists of the maximum event time and an empty two dimensional array:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; t = [0.0, 13.0, 20.0, 22.0, 25.0, 25.0, 25.0, 26.0, 30.0, 35.0, 38.0, 40.0, 40.0, 42.0, 42.0, 47.0, 50.0, 51.0, 55.0, 55.0, 56.0, 57.0, 58.0, 60.0, 60.0, 61.0, 66.0]
27-element Array{Float64,1}:
  0.0
 13.0
 20.0
 22.0
 25.0
 25.0
 25.0
 26.0
 30.0
 35.0
  â‹®
 55.0
 55.0
 56.0
 57.0
 58.0
 60.0
 60.0
 61.0
 66.0

julia&gt; y = Observations([67.0], Array{Int64, 2}(undef, 1, 1));</code></pre>


<p>We also need to define an initial state using the <code>generate_custom_x0</code> function using some parameter values and a vector of event times and corresponding event types, consistent with <code>t</code>:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; evt_tm = Float64[];

julia&gt; evt_tp = Int64[];

julia&gt; for i in 1:(length(t) - 1)# infections at arbitrary t &gt; t0
           push!(evt_tm, -4.0)
           push!(evt_tp, 1)
       end

julia&gt; for i in eachindex(t)     # recoveries
           push!(evt_tm, t[i])
           push!(evt_tp, 2)
       end

julia&gt; x0 = generate_custom_x0(model, y, [0.001, 0.1, -4.0], evt_tm, evt_tp);</code></pre>


<p>The final step before we run our analysis is to define the algorithm which will propose changes to augmented data (parameter proposals are automatically configured by Discuit).</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; function custom_proposal(model::PrivateDiscuitModel, xi::MarkovState, xf_parameters::ParameterProposal)
           t0 = xf_parameters.value[model.t0_index]
           ## move
           seq_f = copy(xi.trajectory)
           # choose event and define new one
           evt_i = rand(1:length(xi.trajectory))
           evt_tm = xi.trajectory[evt_i].event_type == 1 ? (rand() * (model.obs_data.time[end] - t0)) + t0 : floor(xi.trajectory[evt_i].time) + rand()
           evt = Event(evt_tm, xi.trajectory[evt_i].event_type)
           # remove old one
           splice!(seq_f, evt_i)
           # add new one
           if evt.time &gt; seq_f[end].time
               push!(seq_f, evt)
           else
               for i in eachindex(seq_f)
                   if seq_f[i].time &gt; evt.time
                       insert!(seq_f, i, evt)
                       break
                   end
               end
           end
           # compute ln g(x)
           prop_lk = 1.0
           ## evaluate full likelihood for trajectory proposal and return
           return MarkovState(xi.parameters, seq_f, compute_full_log_like(model, xi.parameters.value, seq_f), prop_lk, 3)
       end # end of std proposal function
custom_proposal (generic function with 1 method)</code></pre>


<p>We can now run the MCMC analysis:</p>
<pre class="codehilite"><code class="language-julia-repl">julia&gt; rs = run_custom_mcmc(model, y, custom_proposal, x0, 120000, 20000)

running custom MCMC.ERROR: MethodError: no method matching copy(::Trajectory)
Closest candidates are:
  copy(!Matched::Expr) at expr.jl:36
  copy(!Matched::BitSet) at bitset.jl:46
  copy(!Matched::Markdown.MD) at /buildworker/worker/package_linux64/build/usr/share/julia/stdlib/v1.1/Markdown/src/parse/parse.jl:30
  ...</code></pre>


<p>PLACEHOLDER FOR CUSTOM MCMC VISUAL OUTPUT</p>
<ul>
<li>link to <a href="../manual/#Discuit.set_random_seed"><code>set_random_seed(seed::Int64)</code></a></li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../assets/mathjaxhelper.js"></script>
        <script src="https://cdn.rawgit.com/pcooksey/bibtex-js/ef59e62c/src/bibtex_js.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
